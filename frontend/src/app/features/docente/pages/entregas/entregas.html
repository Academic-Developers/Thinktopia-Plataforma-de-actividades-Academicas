<main>
    <div class="entregas-container">
        <!-- Header con título e icono -->
        <div class="title">
            <div class="title-icon">
                <img src="/icons/check_cicle_icon.svg" alt="Icono de Entregas" />
                <h1>Gestión de Entregas</h1>
            </div>
        </div>

        <!-- Campo de búsqueda manual -->
        <div class="search-section">
            <div class="search-input-group">
                <input type="text" class="form-control" placeholder="Buscar por estudiante..."
                    (input)="aplicarFiltroMateria($any($event.target).value)">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>

        <div class="filters-and-actions-container">
            <app-filters [filters]="filterConfigs" [showMobileVersion]="true" mobileCollapseId="entregasFilters"
                (filterChange)="onFilterChange($event)" (buttonClick)="onFilterButtonClick($event)">
            </app-filters>
        </div>

        <!-- Loading state y datos reactivos -->
        <div *ngIf="loading$ | async" class="loading-container">
            <div class="spinner"></div>
            <p>Cargando entregas...</p>
        </div>

        <section class="table-container" *ngIf="!(loading$ | async)">
            <!-- Datos reactivos -->
            <div *ngIf="entregasFiltradas$ | async as entregas">
                <app-generic-table [columns]="tableColumns" [data]="entregas" [actions]="tableActions" [striped]="true"
                    [hover]="true" [loading]="false" tableClasses="tabla-genérica"
                    emptyMessage="No hay entregas disponibles" (sort)="onTableSort($event)"
                    (rowClick)="onTableRowClick($event)" (actionClick)="onTableAction($event)">
                </app-generic-table>
            </div>
        </section>

        <!-- Modal para calificar entregas -->
        <div *ngIf="showGradeModal$ | async" class="modal-overlay" (click)="cerrarModalCalificar()">
            <div class="modal-container" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h3>
                        <i class="fas" [ngClass]="selectedEntrega?.estado === 'Calificada' ? 'fa-edit' : 'fa-star'"></i>
                        {{ selectedEntrega?.estado === 'Calificada' ? 'Editar Calificación' : 'Calificar Entrega' }}
                    </h3>
                    <button type="button" class="btn-close" (click)="cerrarModalCalificar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form [formGroup]="gradeForm" (ngSubmit)="guardarCalificacion()">
                    <div class="modal-body">
                        <!-- Advertencia para re-calificación -->
                        <div class="alert alert-warning" *ngIf="selectedEntrega?.calificacion !== null">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="warning-content">
                                <p><strong>Atención:</strong></p>
                                <p>Esta entrega ya tiene una calificación de <strong>{{selectedEntrega?.calificacion}}/100</strong>.</p>
                                <p>Los cambios sobrescribirán la calificación anterior.</p>
                            </div>
                        </div>

                        <!-- Calificación -->
                        <div class="form-group">
                            <label for="calificacion">Calificación (0-100) *</label>
                            <input id="calificacion" type="number" class="form-control"
                                [class.is-invalid]="isFieldInvalid('calificacion')" formControlName="calificacion"
                                min="0" max="100" placeholder="Ingrese la calificación">
                            <div *ngIf="isFieldInvalid('calificacion')" class="invalid-feedback">
                                {{getFieldError('calificacion')}}
                            </div>
                        </div>

                        <!-- Comentarios -->
                        <div class="form-group">
                            <label for="comentarios">Comentarios (opcional)</label>
                            <textarea id="comentarios" class="form-control"
                                [class.is-invalid]="isFieldInvalid('comentarios')" formControlName="comentarios"
                                rows="4" maxlength="500" placeholder="Comentarios sobre la entrega...">
                            </textarea>
                            <div *ngIf="isFieldInvalid('comentarios')" class="invalid-feedback">
                                {{getFieldError('comentarios')}}
                            </div>
                            <div class="form-text">
                                {{ gradeForm.get('comentarios')?.value?.length || 0 }}/500 caracteres
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="cerrarModalCalificar()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-enhanced"
                            [disabled]="gradeForm.invalid || (loading$ | async)">
                            <span *ngIf="loading$ | async">
                                <i class="fas fa-spinner fa-spin btn-icon"></i>
                                Guardando...
                            </span>
                            <span *ngIf="!(loading$ | async)">
                                <i class="fas fa-check btn-icon"></i>
                                {{ selectedEntrega?.estado === 'Calificada' ? 'Actualizar Calificación' : 'Guardar Calificación' }}
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para ver detalles de la entrega -->
        <div *ngIf="showViewModal$ | async" class="modal-overlay" (click)="cerrarModalVer()">
            <div class="modal-container modal-view" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-eye"></i>
                        Detalles de la Entrega
                    </h3>
                    <button type="button" class="btn-close" (click)="cerrarModalVer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body" *ngIf="selectedEntregaForView">
                    <!-- Información del estudiante -->
                    <div class="info-section">
                        <h4>
                            <i class="fas fa-user"></i>
                            Información del Estudiante
                        </h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Estudiante:</span>
                                <span class="value">{{ selectedEntregaForView.estudiante_nombre }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la entrega -->
                    <div class="info-section">
                        <h4>
                            <i class="fas fa-tasks"></i>
                            Información de la Entrega
                        </h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Actividad:</span>
                                <span class="value">{{ selectedEntregaForView.actividad_titulo }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Materia:</span>
                                <span class="value">{{ selectedEntregaForView.materia_nombre }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Fecha de Entrega:</span>
                                <span class="value">{{ selectedEntregaForView.fechaEntrega | date:'dd/MM/yyyy HH:mm'
                                    }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Estado:</span>
                                <span class="value badge" [ngClass]="{
                                'badge-success': selectedEntregaForView.estado === 'Calificada',
                                'badge-info': selectedEntregaForView.estado === 'Entregada',
                                'badge-warning': selectedEntregaForView.estado === 'Pendiente',
                                'badge-danger': selectedEntregaForView.estado === 'Atrasada'
                              }">
                                    {{ selectedEntregaForView.estado }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Archivo entregado -->
                    <div class="info-section" *ngIf="selectedEntregaForView.archivo_url">
                        <h4>
                            <i class="fas fa-file"></i>
                            Archivo Entregado
                        </h4>
                        <div class="file-info">
                            <i class="fas fa-download"></i>
                            <span class="file-name">{{ selectedEntregaForView.archivo_url }}</span>
                            <button type="button" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-download"></i>
                                Descargar
                            </button>
                        </div>
                    </div>

                    <!-- Comentarios del estudiante -->
                    <div class="info-section" *ngIf="selectedEntregaForView.comentarios_estudiante">
                        <h4>
                            <i class="fas fa-comment"></i>
                            Comentarios del Estudiante
                        </h4>
                        <div class="comment-box">
                            {{ selectedEntregaForView.comentarios_estudiante }}
                        </div>
                    </div>

                    <!-- Calificación (si existe) -->
                    <div class="info-section" *ngIf="selectedEntregaForView.calificacion !== null">
                        <h4>
                            <i class="fas fa-star"></i>
                            Calificación
                        </h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Nota:</span>
                                <span class="value grade">{{ selectedEntregaForView.calificacion }}/100</span>
                            </div>
                        </div>
                        
                        <!-- Comentarios del docente -->
                        <div *ngIf="selectedEntregaForView.comentarios_docente" style="margin-top: 1rem;">
                            <h5 style="margin: 0 0 0.75rem 0; color: var(--text-color); font-family: var(--font-title-secondary); font-size: 1rem; font-weight: 600;">
                                <i class="fas fa-comment-dots" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                                Comentarios del Docente:
                            </h5>
                            <div class="comment-box">
                                {{ selectedEntregaForView.comentarios_docente }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModalVer()">
                        <i class="fas fa-times"></i>
                        Cerrar
                    </button>
                    <!-- Botón para calificar (cuando no está calificada) -->
                    <button type="button" class="btn btn-enhanced" (click)="irACalificarDesdeVer()"
                        *ngIf="selectedEntregaForView?.estado !== 'Calificada'">
                        <i class="fas fa-edit"></i>
                        Calificar
                    </button>
                    <!-- Botón para editar calificación (cuando ya está calificada) -->
                    <button type="button" class="btn btn-warning" (click)="irACalificarDesdeVer()"
                        *ngIf="selectedEntregaForView?.estado === 'Calificada'">
                        <i class="fas fa-edit"></i>
                        Editar Calificación
                    </button>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </div>
</main>